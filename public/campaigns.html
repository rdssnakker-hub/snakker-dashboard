<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snakker Campaign Hub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #f5f5f7;
      color: #1a1a1a;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e5e5;
      padding: 20px 40px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .header-filters {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .filter-group {
      display: flex;
      gap: 8px;
    }

    .filter-label {
      font-size: 12px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      align-self: center;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      cursor: pointer;
      color: #1a1a1a;
    }

    .filter-select:hover {
      border-color: #7c3aed;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #7c3aed;
      color: white;
    }

    .btn-primary:hover {
      background: #6d28d9;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #1a1a1a;
      border: 1px solid #e5e5e5;
    }

    .btn-secondary:hover {
      background: #e5e5e5;
    }

    .container {
      display: grid;
      grid-template-columns: 320px 1fr;
      min-height: calc(100vh - 73px);
      max-width: 100%;
    }

    .sidebar {
      background: white;
      border-right: 1px solid #e5e5e5;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-title {
      font-size: 12px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .campaign-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .campaign-item:hover {
      background: #f5f5f7;
      border-left-color: #7c3aed;
    }

    .campaign-item.active {
      background: #f0e5ff;
      border-left-color: #7c3aed;
      border: 1px solid #e5d9f2;
    }

    .campaign-name {
      font-size: 14px;
      font-weight: 500;
      color: #1a1a1a;
    }

    .campaign-meta {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .campaign-progress-bar {
      height: 4px;
      background: #f0f0f0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }

    .campaign-progress-fill {
      height: 100%;
      background: #7c3aed;
      transition: width 0.3s;
    }

    .campaign-status {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .main {
      padding: 40px;
      overflow-y: auto;
      background: #f5f5f7;
    }

    .campaign-header {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid #e5e5e5;
    }

    .campaign-title {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .campaign-details {
      display: flex;
      gap: 24px;
      font-size: 14px;
      color: #666;
    }

    .detail-item {
      display: flex;
      gap: 6px;
    }

    .detail-label {
      font-weight: 500;
      color: #999;
    }

    /* Main Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #e5e5e5;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .card-subtitle {
      font-size: 13px;
      color: #999;
      margin: 8px 0;
    }

    /* Flash Brief */
    .flash-brief-content {
      background: #fafafa;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }

    .flash-brief-label {
      color: #7c3aed;
      font-weight: bold;
    }

    /* Storyboard */
    .storyboard-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .story-option {
      background: #fafafa;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .story-option:hover {
      border-color: #7c3aed;
      background: #f5e5ff;
    }

    .story-number {
      display: inline-block;
      background: #7c3aed;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-weight: 600;
      font-size: 12px;
      margin-right: 8px;
    }

    .story-title {
      font-weight: 600;
      color: #1a1a1a;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .story-content {
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }

    .magic-links {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .link-btn {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .link-btn:hover {
      background: #6d28d9;
    }

    /* Chat Section */
    .chat-section {
      grid-column: 1 / -1;
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #e5e5e5;
    }

    .chat-messages {
      background: #fafafa;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 16px;
      height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 8px;
      max-width: 85%;
    }

    .message.user {
      justify-content: flex-end;
      margin-left: auto;
    }

    .message.ai {
      justify-content: flex-start;
    }

    .message-bubble {
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.4;
    }

    .message.user .message-bubble {
      background: #7c3aed;
      color: white;
    }

    .message.ai .message-bubble {
      background: #f0f0f0;
      color: #333;
    }

    .chat-input-area {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      padding: 12px;
      font-size: 13px;
      font-family: inherit;
      color: #1a1a1a;
    }

    .chat-input:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .chat-send {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .chat-send:hover {
      background: #6d28d9;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn-large {
      flex: 1;
      min-width: 150px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 14px;
      color: #bbb;
    }

    /* Workflow Stages */
    .workflow-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #e5e5e5;
      margin-bottom: 24px;
    }

    .workflow-stages {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
    }

    .stage {
      text-align: center;
    }

    .stage-number {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      margin: 0 auto 8px;
      color: white;
    }

    .stage.completed .stage-number {
      background: #22c55e;
    }

    .stage.in-progress .stage-number {
      background: #7c3aed;
    }

    .stage.pending .stage-number {
      background: #d0d0d0;
      color: #666;
    }

    .stage-name {
      font-size: 12px;
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .stage-status {
      font-size: 11px;
      color: #999;
    }

    .stage-date {
      font-size: 10px;
      color: #bbb;
      margin-top: 4px;
    }

    /* Magic Patterns Links */
    .magic-links-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .magic-link-card {
      background: #f9f9f9;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .magic-link-title {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
    }

    .magic-link-buttons {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .magic-link-btn {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .magic-link-btn:hover {
      background: #6d28d9;
    }

    @media (max-width: 1024px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e5e5e5;
        padding: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }

      .sidebar-section {
        margin-bottom: 0;
      }

      .header {
        padding: 16px 20px;
      }

      .main {
        padding: 20px;
      }

      .workflow-stages {
        grid-template-columns: repeat(3, 1fr);
      }

      .magic-links-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-top">
      <div>
        <h1>üß†‚ú® Snakker Campaign Hub</h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary">üìä Dashboard</button>
        <button class="btn btn-primary">‚ûï New Campaign</button>
      </div>
    </div>
    <div class="header-filters">
      <div class="filter-group">
        <span class="filter-label">Company</span>
        <select class="filter-select" id="filterCompany" onchange="applyFilters()">
          <option value="">All Companies</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Region</span>
        <select class="filter-select" id="filterRegion" onchange="applyFilters()">
          <option value="">All Regions</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Status</span>
        <select class="filter-select" id="filterStatus" onchange="applyFilters()">
          <option value="">All Statuses</option>
          <option value="completed">Completed</option>
          <option value="pending">Pending</option>
          <option value="in-progress">In Progress</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Sidebar: Campaign List -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Campaigns</div>
        <div id="campaign-list"></div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main" id="main-content">
      <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <div class="empty-state-text">Select a campaign to get started</div>
        <div class="empty-state-subtext">Choose from the list on the left to view and manage</div>
      </div>
    </div>
  </div>

  <script>
    let campaigns = [];
    let selectedCampaign = null;

    async function loadCampaigns() {
      try {
        const response = await fetch('/api/campaigns');
        const data = await response.json();
        campaigns = Array.isArray(data) ? data : data.campaigns || [];
        
        // Populate filter options
        const companies = [...new Set(campaigns.map(c => c.company))];
        const regions = [...new Set(campaigns.map(c => c.country))];
        
        const companySelect = document.getElementById('filterCompany');
        const regionSelect = document.getElementById('filterRegion');
        
        companies.forEach(company => {
          const option = document.createElement('option');
          option.value = company;
          option.textContent = company;
          companySelect.appendChild(option);
        });
        
        regions.forEach(region => {
          const option = document.createElement('option');
          option.value = region;
          option.textContent = region;
          regionSelect.appendChild(option);
        });
        
        renderCampaignList();
        if (campaigns.length > 0) {
          selectCampaign(campaigns[0]);
        }
      } catch (error) {
        console.error('Error loading campaigns:', error);
      }
    }

    function renderCampaignList() {
      const list = document.getElementById('campaign-list');
      const filtered = applyFilters();
      
      list.innerHTML = filtered.map((campaign, i) => `
        <div class="campaign-item ${selectedCampaign?.id === campaign.id ? 'active' : ''}" 
             onclick="selectCampaign(campaign)">
          <div class="campaign-name">${campaign.product}</div>
          <div class="campaign-meta">${campaign.company} ‚Ä¢ ${campaign.country}</div>
          <div class="campaign-progress-bar">
            <div class="campaign-progress-fill" style="width: ${campaign.progress || 0}%"></div>
          </div>
          <div class="campaign-status">${campaign.currentStage || 'Planning'}</div>
        </div>
      `).join('');
    }

    function applyFilters() {
      const company = document.getElementById('filterCompany')?.value || '';
      const region = document.getElementById('filterRegion')?.value || '';
      const status = document.getElementById('filterStatus')?.value || '';

      let filtered = campaigns;
      if (company) filtered = filtered.filter(c => c.company === company);
      if (region) filtered = filtered.filter(c => c.country === region);
      if (status) filtered = filtered.filter(c => c.currentStage === status);

      renderCampaignList();
      return filtered;
    }

    async function selectCampaign(campaign) {
      selectedCampaign = campaign;
      renderCampaignList();
      renderCampaignDetail();
    }

    function renderCampaignDetail() {
      if (!selectedCampaign) return;

      const main = document.getElementById('main-content');
      const campaign = selectedCampaign;

      // Build workflow stages HTML
      const stages = campaign.stages || [
        { id: 1, name: 'Intake', status: 'completed' },
        { id: 2, name: 'Flash Brief', status: 'in-progress' },
        { id: 3, name: 'Storyboard', status: 'pending' },
        { id: 4, name: 'Magic Patterns', status: 'pending' },
        { id: 5, name: 'Snakker Brief', status: 'pending' },
        { id: 6, name: 'Deployment', status: 'pending' }
      ];

      const workflowHTML = stages.map(stage => `
        <div class="stage ${stage.status}">
          <div class="stage-number">${stage.id}</div>
          <div class="stage-name">${stage.name}</div>
          <div class="stage-status">${stage.status.replace('-', ' ')}</div>
          ${stage.date ? `<div class="stage-date">${stage.date}</div>` : ''}
        </div>
      `).join('');

      main.innerHTML = `
        <div class="campaign-header">
          <h1 class="campaign-title">${campaign.product}</h1>
          <div class="campaign-details">
            <div class="detail-item">
              <span class="detail-label">Company:</span>
              <span>${campaign.company}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Location:</span>
              <span>${campaign.country}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Progress:</span>
              <span>${campaign.progress || 0}%</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Status:</span>
              <span>${campaign.currentStage || 'Planning'}</span>
            </div>
          </div>
        </div>

        <!-- Workflow Pipeline -->
        <div class="workflow-container">
          <h3 class="card-title" style="margin-bottom: 16px;">üìä Workflow Pipeline</h3>
          <div class="workflow-stages">
            ${workflowHTML}
          </div>
        </div>

        <div class="content-grid">
          <!-- Flash Brief -->
          <div class="card">
            <div class="card-header">
              <div>
                <h3 class="card-title">üìã Flash Brief</h3>
                <p class="card-subtitle">Campaign overview</p>
              </div>
              <button class="btn btn-secondary" onclick="editFlashBrief()">Edit</button>
            </div>
            <div class="flash-brief-content" id="flash-brief">
              ${campaign.flashBrief ? campaign.flashBrief.split('\n').map(line => {
                if (line.includes(':')) {
                  const [label, ...content] = line.split(':');
                  return `<div><span class="flash-brief-label">${label}:</span> ${content.join(':').trim()}</div>`;
                }
                return `<div>${line}</div>`;
              }).join('') : '<p style="color: #999;">No brief available</p>'}
            </div>
          </div>

          <!-- Storyboard -->
          <div class="card">
            <div class="card-header">
              <div>
                <h3 class="card-title">üé¨ Storyboard</h3>
                <p class="card-subtitle">3 strategic FABP options</p>
              </div>
            </div>
            <div class="storyboard-options" id="storyboard">
              ${campaign.storyboard ? campaign.storyboard : '<p style="color: #999;">No storyboard available</p>'}
            </div>
          </div>
        </div>

        <!-- Magic Patterns Links -->
        ${campaign.magicPatterns ? `
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <div>
                <h3 class="card-title">‚ú® Magic Patterns Designs</h3>
                <p class="card-subtitle">Interactive mockups for each FABP option</p>
              </div>
            </div>
            <div class="magic-links-grid">
              <div class="magic-link-card">
                <div class="magic-link-title">Option 1</div>
                <div class="magic-link-buttons">
                  <a href="${campaign.magicPatterns.editorUrl || '#'}" target="_blank" class="magic-link-btn">üîó Edit</a>
                  <a href="${campaign.magicPatterns.previewUrl || '#'}" target="_blank" class="magic-link-btn">üëÅÔ∏è Preview</a>
                </div>
              </div>
              <div class="magic-link-card">
                <div class="magic-link-title">Option 2</div>
                <div class="magic-link-buttons">
                  <a href="${(campaign.magicPatterns.editorUrl || '').replace('-001', '-002')}" target="_blank" class="magic-link-btn">üîó Edit</a>
                  <a href="${(campaign.magicPatterns.previewUrl || '').replace('-001', '-002')}" target="_blank" class="magic-link-btn">üëÅÔ∏è Preview</a>
                </div>
              </div>
              <div class="magic-link-card">
                <div class="magic-link-title">Option 3</div>
                <div class="magic-link-buttons">
                  <a href="${(campaign.magicPatterns.editorUrl || '').replace('-001', '-003')}" target="_blank" class="magic-link-btn">üîó Edit</a>
                  <a href="${(campaign.magicPatterns.previewUrl || '').replace('-001', '-003')}" target="_blank" class="magic-link-btn">üëÅÔ∏è Preview</a>
                </div>
              </div>
            </div>
          </div>
        ` : ''}

        <!-- Chat Section -->
        <div class="chat-section">
          <div class="card-header">
            <div>
              <h3 class="card-title">üí¨ Snakker Cortex Chat</h3>
              <p class="card-subtitle">Chat naturally to revise brief and storyboard</p>
            </div>
          </div>

          <div class="chat-messages" id="chat-messages">
            <div class="message ai">
              <div class="message-bubble">
                üëã Hi! I'm Snakker Cortex. You can chat to update this campaign:
                <br>‚Ä¢ Change audience, device, or channel
                <br>‚Ä¢ Revise the problem or objective
                <br>‚Ä¢ Update success metrics
                <br>
                <br>Type naturally and I'll update the brief instantly!
              </div>
            </div>
          </div>

          <div class="chat-input-area">
            <input type="text" class="chat-input" id="chat-input" placeholder="E.g., 'Change audience to nurses' or 'Make it mobile-first'..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="chat-send" onclick="sendChat()">Send</button>
          </div>

          <div class="action-buttons">
            <button class="btn btn-primary btn-large" onclick="regenerateMagicPatterns()">‚ú® Regenerate Magic Patterns</button>
            <button class="btn btn-secondary btn-large" onclick="editCampaign()">üìù Edit Campaign</button>
          </div>
        </div>
      `;

      document.getElementById('chat-input').focus();
    }

    function addChatMessage(role, message) {
      const messagesDiv = document.getElementById('chat-messages');
      const messageEl = document.createElement('div');
      messageEl.className = `message ${role}`;
      messageEl.innerHTML = `<div class="message-bubble">${message}</div>`;
      messagesDiv.appendChild(messageEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendChat() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message || !selectedCampaign) return;

      addChatMessage('user', message);
      input.value = '';

      try {
        const response = await fetch(`/api/campaigns/${selectedCampaign.id}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const result = await response.json();
        if (result.success) {
          addChatMessage('ai', result.response || '‚úÖ Updated!');
          selectedCampaign = result.campaign;
          renderCampaignDetail();
        } else {
          addChatMessage('ai', `‚ùå ${result.error}`);
        }
      } catch (error) {
        addChatMessage('ai', `‚ùå Error: ${error.message}`);
      }
    }

    async function regenerateMagicPatterns() {
      if (!selectedCampaign) return;
      
      addChatMessage('ai', '‚ú® Regenerating Magic Patterns...');
      
      try {
        const response = await fetch(`/api/campaigns/${selectedCampaign.id}/regenerate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();
        if (result.success) {
          addChatMessage('ai', '‚úÖ Regenerated! New mockups are ready.');
          selectedCampaign = result.campaign;
          renderCampaignDetail();
        } else {
          addChatMessage('ai', `‚ùå ${result.error}`);
        }
      } catch (error) {
        addChatMessage('ai', `‚ùå Error: ${error.message}`);
      }
    }

    function editFlashBrief() {
      alert('Edit modal would open here for flash brief');
    }

    function editCampaign() {
      alert('Edit modal would open here for full campaign');
    }

    // Load on startup
    loadCampaigns();
  </script>
</body>
</html>
