<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snakker Campaign Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      color: #1a1a1a;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      margin-bottom: 40px;
      border-bottom: 1px solid #e5e5e5;
      padding-bottom: 20px;
      background: white;
      padding: 20px 40px;
      margin: -20px -20px 40px -20px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #1a1a1a;
    }

    .subtitle {
      color: #666;
      font-size: 0.95rem;
    }

    .campaigns-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .campaign-card {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .campaign-card:hover {
      border-color: #7c3aed;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.1);
      transform: translateY(-2px);
    }

    .campaign-header {
      margin-bottom: 15px;
    }

    .campaign-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: #1a1a1a;
      margin-bottom: 5px;
    }

    .campaign-meta {
      font-size: 0.85rem;
      color: #999;
      margin-bottom: 10px;
    }

    .campaign-status {
      display: inline-block;
      padding: 4px 12px;
      background: #7c3aed;
      color: #fff;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .progress-bar {
      background: #e5e5e5;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, #7c3aed, #a78bfa);
      height: 100%;
      transition: width 0.3s ease;
    }

    .stage-info {
      font-size: 0.85rem;
      color: #999;
      margin-top: 10px;
    }

    .detail-view {
      display: none;
    }

    .detail-view.active {
      display: block;
    }

    .back-btn {
      background: #7c3aed;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin-bottom: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .back-btn:hover {
      background: #6d28d9;
    }

    .detail-container {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 30px;
    }

    .detail-header {
      margin-bottom: 30px;
      border-bottom: 1px solid #e5e5e5;
      padding-bottom: 20px;
    }

    .detail-title {
      font-size: 1.8rem;
      color: #1a1a1a;
      font-weight: bold;
      color: #fff;
      margin-bottom: 10px;
    }

    .detail-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
      font-size: 0.9rem;
    }

    .meta-item label {
      color: #999;
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
    }

    .meta-item value {
      color: #fff;
    }

    .section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: #fff;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e5e5;
    }

    .workflow-stages {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .stage-item {
      background: #f5f5f7;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .stage-number {
      background: #7c3aed;
      color: #fff;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
    }

    .stage-details {
      flex-grow: 1;
    }

    .stage-name {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 3px;
    }

    .stage-meta {
      font-size: 0.8rem;
      color: #999;
    }

    .stage-status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-completed {
      background: #22c55e;
      color: #fff;
    }

    .status-in-progress {
      background: #7c3aed;
      color: #fff;
    }

    .status-pending {
      background: #d1d5db;
      color: #1a1a1a;
    }

    .flash-brief, .storyboard-section {
      background: #f5f5f7;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .flash-brief pre, .storyboard-section pre {
      background: #fafafa;
      color: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85rem;
      line-height: 1.5;
      border: 1px solid #e5e5e5;
    }

    .edit-btn {
      background: #7c3aed;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 10px;
    }

    .edit-btn:hover {
      background: #1a91da;
    }

    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .edit-modal.active {
      display: flex;
    }

    .edit-modal-content {
      background: #ffffff;
      border-radius: 8px;
      padding: 30px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .edit-modal-header {
      font-size: 1.3rem;
      font-weight: bold;
      color: #fff;
      margin-bottom: 20px;
    }

    .edit-modal textarea {
      width: 100%;
      height: 400px;
      background: #f5f5f7;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      color: #1a1a1a;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .edit-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .modal-btn-save {
      background: #17bf63;
      color: #fff;
    }

    .modal-btn-cancel {
      background: #657786;
      color: #fff;
    }

    .audit-log {
      background: #f5f5f7;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      padding: 15px;
    }

    .audit-entry {
      padding: 12px 0;
      border-bottom: 1px solid #e5e5e5;
      font-size: 0.9rem;
    }

    .audit-entry:last-child {
      border-bottom: none;
    }

    .audit-timestamp {
      color: #999;
      font-size: 0.8rem;
    }

    .audit-action {
      color: #1da1f2;
      font-weight: 600;
      margin: 5px 0;
    }

    .audit-actor {
      color: #999;
      font-size: 0.85rem;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .error {
      background: #8b3a3a;
      border: 1px solid #d32f2f;
      color: #ffcccc;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Snakker Campaign Dashboard</h1>
      <p class="subtitle">Real-time tracking for all campaigns through the Cortex automation pipeline</p>
    </header>

    <div id="campaigns-view">
      <div id="campaigns-container" class="campaigns-grid">
        <div class="loading">Loading campaigns...</div>
      </div>
    </div>

    <div id="detail-view" class="detail-view">
      <button class="back-btn" onclick="goBack()">‚Üê Back to Campaigns</button>
      <div class="detail-container">
        <div class="detail-header">
          <h2 class="detail-title" id="detail-title"></h2>
          <div class="detail-meta">
            <div class="meta-item">
              <label>Company</label>
              <value id="detail-company"></value>
            </div>
            <div class="meta-item">
              <label>Product</label>
              <value id="detail-product"></value>
            </div>
            <div class="meta-item">
              <label>Country</label>
              <value id="detail-country"></value>
            </div>
            <div class="meta-item">
              <label>Contact</label>
              <value id="detail-contact"></value>
            </div>
            <div class="meta-item">
              <label>Timeline</label>
              <value id="detail-timeline"></value>
            </div>
            <div class="meta-item">
              <label>Created</label>
              <value id="detail-created"></value>
            </div>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">‚öôÔ∏è Workflow Pipeline</h3>
          <div class="workflow-stages" id="workflow-stages"></div>
        </div>

        <div class="section">
          <h3 class="section-title">‚ö° Flash Brief</h3>
          <div class="flash-brief" id="flash-brief" style="background: #ffffff; color: #1a1a1a; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
            <p style="color: #999;">Loading brief...</p>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <button class="edit-btn" onclick="editFlashBrief()">üìù Edit Flash Brief</button>
            <button class="edit-btn" onclick="requestFlashBriefRevision()">üí¨ Request Revision</button>
            <button class="edit-btn" onclick="regenerateMagicPatterns()" style="background: #7c3aed; color: white;">‚ú® Regenerate Magic Patterns</button>
          </div>
          <div id="flash-brief-revisions" style="margin-top: 15px; font-size: 0.85rem; color: #999;"></div>
        </div>

        <div class="section" style="background: #ffffff; border-radius: 8px; padding: 20px; margin-top: 20px;">
          <h3 class="section-title" style="color: #1a1a1a;">üí¨ Snakker Cortex Chat</h3>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">Chat naturally to revise the brief and storyboard. Changes auto-save to campaign.json</p>
          
          <div id="chat-messages" style="background: #fafafa; border: 1px solid #e5e5e5; border-radius: 6px; height: 300px; overflow-y: auto; padding: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;">
            <div style="background: #ffffff; border: 1px solid #e5e5e5; border-radius: 6px; padding: 12px; color: #333;">
              üëã Hi! I'm Snakker Cortex. You can chat to:
              <br>‚Ä¢ Change the problem or challenge
              <br>‚Ä¢ Update audience, device, or channel
              <br>‚Ä¢ Revise the campaign objective or CTA
              <br>‚Ä¢ Refine success metrics
              <br><br>Just type naturally, and I'll update the brief. Then click <strong>Regenerate</strong> to update Magic Patterns designs.
            </div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <input type="text" id="chat-input" placeholder="E.g., 'Change audience to nurses' or 'Make it mobile-first'..." style="flex: 1; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px; font-family: inherit; font-size: 13px; color: #333;">
            <button onclick="sendChatMessage()" style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">Send</button>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">üìã Storyboard</h3>
          <div class="storyboard-section" id="storyboard">
            <p style="color: #999;">No storyboard available yet.</p>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="edit-btn" onclick="editStoryboard()">‚úèÔ∏è Edit Storyboard</button>
            <button class="edit-btn" onclick="requestStoryboardRevision()">üí¨ Request Revision</button>
          </div>
          <div id="storyboard-revisions" style="margin-top: 15px; font-size: 0.85rem; color: #999;"></div>
        </div>

        <div class="section">
          <h3 class="section-title">‚ú® Magic Patterns Designs</h3>
          <div id="magic-patterns-links" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <p style="grid-column: 1/-1; color: #999;">Loading designs...</p>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">üí¨ Campaign Chat</h3>
          <div id="chat-messages-container" style="background: #fafafa; border: 1px solid #e5e5e5; border-radius: 8px; padding: 16px; height: 250px; overflow-y: auto; margin-bottom: 12px; display: flex; flex-direction: column; gap: 8px;">
            <div style="padding: 10px; background: #f0f0f0; border-radius: 6px; font-size: 13px;">
              üëã Hi! Chat to update this campaign. Try: "Change audience to nurses" or "Make it mobile-first"
            </div>
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="chat-input-field" placeholder="Type a message..." style="flex: 1; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 13px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button class="edit-btn" onclick="sendChatMessage()">Send</button>
            <button class="edit-btn" onclick="regeneratePatterns()">‚ú® Regenerate</button>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">üìã Audit Log</h3>
          <div class="audit-log" id="audit-log"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="edit-modal" class="edit-modal">
    <div class="edit-modal-content">
      <div class="edit-modal-header" id="edit-modal-title"></div>
      <textarea id="edit-modal-textarea" placeholder="Enter content here..."></textarea>
      <div class="edit-modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn modal-btn-save" onclick="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="revision-modal" class="edit-modal">
    <div class="edit-modal-content">
      <div class="edit-modal-header">üí¨ Request Revision</div>
      <textarea id="revision-prompt" placeholder="Describe what you'd like to change (e.g., 'Make the hook more punchy' or 'Add more clinical evidence')..." style="height: 150px;"></textarea>
      <div class="edit-modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeRevisionModal()">Cancel</button>
        <button class="modal-btn modal-btn-save" onclick="submitRevisionRequest()">Request Revision</button>
      </div>
    </div>
  </div>

  <script>
    let campaigns = [];
    let currentCampaign = null;
    let editingField = null;
    let revisionField = null;

    async function loadCampaigns() {
      try {
        const response = await fetch('/api/campaigns');
        campaigns = await response.json();
        renderCampaigns();
      } catch (error) {
        console.error('Error loading campaigns:', error);
        document.getElementById('campaigns-container').innerHTML = `
          <div class="error">Failed to load campaigns. Make sure the backend server is running.</div>
        `;
      }
    }

    function renderCampaigns() {
      const container = document.getElementById('campaigns-container');
      if (campaigns.length === 0) {
        container.innerHTML = '<div class="loading">No campaigns found.</div>';
        return;
      }

      container.innerHTML = campaigns.map(c => `
        <div class="campaign-card" onclick="viewCampaign('${c.id}')">
          <div class="campaign-header">
            <div class="campaign-title">${c.product}</div>
            <div class="campaign-meta">${c.company} ‚Ä¢ ${c.country}</div>
            <span class="campaign-status">${c.currentStage}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${c.progress}%"></div>
          </div>
          <div class="stage-info">
            Progress: ${c.progress}% ‚Ä¢ Contact: ${c.contact}
          </div>
        </div>
      `).join('');
    }

    async function viewCampaign(id) {
      try {
        const response = await fetch(`/api/campaigns/${id}`);
        currentCampaign = await response.json();
        renderCampaignDetail();
        document.getElementById('campaigns-view').style.display = 'none';
        document.getElementById('detail-view').classList.add('active');
      } catch (error) {
        console.error('Error loading campaign:', error);
        alert('Failed to load campaign details');
      }
    }

    function renderCampaignDetail() {
      const c = currentCampaign;
      
      document.getElementById('detail-title').textContent = `${c.product} ‚Äî ${c.company}`;
      document.getElementById('detail-company').textContent = c.company;
      document.getElementById('detail-product').textContent = c.product;
      document.getElementById('detail-country').textContent = c.country;
      document.getElementById('detail-contact').textContent = c.contact;
      document.getElementById('detail-timeline').textContent = c.timeline;
      document.getElementById('detail-created').textContent = new Date(c.created).toLocaleDateString();

      // Load revision history
      loadRevisionHistory();

      // Render workflow stages
      const stagesContainer = document.getElementById('workflow-stages');
      stagesContainer.innerHTML = c.stages.map((s, idx) => `
        <div class="stage-item">
          <div class="stage-number">${s.id}</div>
          <div class="stage-details">
            <div class="stage-name">${s.name}</div>
            <div class="stage-meta">Owner: ${s.owner} ‚Ä¢ Started: ${s.started || 'Not started'}</div>
          </div>
          <span class="stage-status-badge status-${s.status}">${s.status}</span>
        </div>
      `).join('');

      // Render flash brief
      if (c.flashBrief) {
        document.getElementById('flash-brief').innerHTML = `<pre>${escapeHtml(c.flashBrief)}</pre>`;
      }

      // Render storyboard
      if (c.storyboard) {
        document.getElementById('storyboard').innerHTML = `<pre>${escapeHtml(c.storyboard)}</pre>`;
      }

      // Render Magic Patterns links
      const mpContainer = document.getElementById('magic-patterns-links');
      if (c.magicPatterns) {
        mpContainer.innerHTML = `
          <div style="background: #f5f5f7; border: 1px solid #e5e5e5; border-radius: 8px; padding: 12px; text-align: center;">
            <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px; font-size: 13px;">Option 1</div>
            <div style="display: flex; gap: 6px; justify-content: center;">
              <a href="${c.magicPatterns.editorUrl || '#'}" target="_blank" style="background: #7c3aed; color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: 600;">üîó Edit</a>
              <a href="${c.magicPatterns.previewUrl || '#'}" target="_blank" style="background: #7c3aed; color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: 600;">üëÅÔ∏è Preview</a>
            </div>
          </div>
          <div style="background: #f5f5f7; border: 1px solid #e5e5e5; border-radius: 8px; padding: 12px; text-align: center;">
            <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px; font-size: 13px;">Option 2</div>
            <div style="display: flex; gap: 6px; justify-content: center;">
              <a href="${(c.magicPatterns.editorUrl || '').replace('-001', '-002')}" target="_blank" style="background: #7c3aed; color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: 600;">üîó Edit</a>
              <a href="${(c.magicPatterns.previewUrl || '').replace('-001', '-002')}" target="_blank" style="background: #7c3aed; color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: 600;">üëÅÔ∏è Preview</a>
            </div>
          </div>
          <div style="background: #f5f5f7; border: 1px solid #e5e5e5; border-radius: 8px; padding: 12px; text-align: center;">
            <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px; font-size: 13px;">Option 3</div>
            <div style="display: flex; gap: 6px; justify-content: center;">
              <a href="${(c.magicPatterns.editorUrl || '').replace('-001', '-003')}" target="_blank" style="background: #7c3aed; color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: 600;">üîó Edit</a>
              <a href="${(c.magicPatterns.previewUrl || '').replace('-001', '-003')}" target="_blank" style="background: #7c3aed; color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: 600;">üëÅÔ∏è Preview</a>
            </div>
          </div>
        `;
      } else {
        mpContainer.innerHTML = '<p style="grid-column: 1/-1; color: #999;">No Magic Patterns designs yet. Click "Regenerate" to create them.</p>';
      }

      // Render audit log
      const auditContainer = document.getElementById('audit-log');
      if (c.auditLog && c.auditLog.length > 0) {
        auditContainer.innerHTML = c.auditLog.map(entry => `
          <div class="audit-entry">
            <div class="audit-timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
            <div class="audit-action">${entry.action}</div>
            <div class="audit-actor">By: ${entry.actor}</div>
            ${entry.details ? `<div style="color: #999; font-size: 0.8rem; margin-top: 5px;">${entry.details}</div>` : ''}
          </div>
        `).join('');
      } else {
        auditContainer.innerHTML = '<p style="color: #999;">No audit entries yet.</p>';
      }
    }

    function goBack() {
      currentCampaign = null;
      document.getElementById('detail-view').classList.remove('active');
      document.getElementById('campaigns-view').style.display = 'block';
    }

    function editStoryboard() {
      editingField = 'storyboard';
      document.getElementById('edit-modal-title').textContent = '‚úèÔ∏è Edit Storyboard';
      document.getElementById('edit-modal-textarea').value = currentCampaign.storyboard || '';
      document.getElementById('edit-modal').classList.add('active');
    }

    function editFlashBrief() {
      editingField = 'flashBrief';
      document.getElementById('edit-modal-title').textContent = '‚ö° Edit Flash Brief';
      document.getElementById('edit-modal-textarea').value = currentCampaign.flashBrief || '';
      document.getElementById('edit-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('edit-modal').classList.remove('active');
      editingField = null;
    }

    async function saveEdit() {
      if (!editingField) return;

      const newContent = document.getElementById('edit-modal-textarea').value;
      
      try {
        const response = await fetch(`/api/campaigns/${currentCampaign.id}/storyboard`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ storyboardText: newContent })
        });

        if (response.ok) {
          currentCampaign[editingField] = newContent;
          renderCampaignDetail();
          closeModal();
          alert('Changes saved successfully!');
        }
      } catch (error) {
        console.error('Error saving changes:', error);
        alert('Failed to save changes');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function addChatMessage(role, text) {
      const messagesDiv = document.getElementById('chat-messages-container');
      if (!messagesDiv) return;
      const msg = document.createElement('div');
      msg.style.cssText = `padding: 8px 12px; border-radius: 6px; font-size: 12px; max-width: 80%; word-wrap: break-word; ${
        role === 'user' 
          ? 'background: #7c3aed; color: white; align-self: flex-end; margin-left: auto;'
          : 'background: #e5e5e5; color: #1a1a1a;'
      }`;
      msg.textContent = text;
      messagesDiv.appendChild(msg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input-field');
      if (!input) return;
      const message = input.value.trim();
      if (!message || !currentCampaign) return;

      addChatMessage('user', message);
      input.value = '';

      try {
        const response = await fetch(`/api/campaigns/${currentCampaign.id}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const result = await response.json();
        if (result.success) {
          addChatMessage('ai', result.response || '‚úÖ Updated!');
          // Refresh campaign data
          const refreshResp = await fetch(`/api/campaigns/${currentCampaign.id}`);
          currentCampaign = await refreshResp.json();
          renderCampaignDetail();
        } else {
          addChatMessage('ai', `‚ùå ${result.error || 'Error'}`);
        }
      } catch (error) {
        addChatMessage('ai', `‚ùå Error: ${error.message}`);
      }
    }

    async function regeneratePatterns() {
      if (!currentCampaign) return;
      
      addChatMessage('ai', '‚ú® Regenerating Magic Patterns...');

      try {
        const response = await fetch(`/api/campaigns/${currentCampaign.id}/regenerate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();
        if (result.success) {
          addChatMessage('ai', '‚úÖ Regenerated! New designs ready.');
          // Refresh campaign data
          const refreshResp = await fetch(`/api/campaigns/${currentCampaign.id}`);
          currentCampaign = await refreshResp.json();
          renderCampaignDetail();
        } else {
          addChatMessage('ai', `‚ùå ${result.error || 'Error'}`);
        }
      } catch (error) {
        addChatMessage('ai', `‚ùå Error: ${error.message}`);
      }
    }

    function requestFlashBriefRevision() {
      revisionField = 'flashBrief';
      document.getElementById('revision-modal').classList.add('active');
      document.getElementById('revision-prompt').focus();
    }

    function requestStoryboardRevision() {
      revisionField = 'storyboard';
      document.getElementById('revision-modal').classList.add('active');
      document.getElementById('revision-prompt').focus();
    }

    function closeRevisionModal() {
      document.getElementById('revision-modal').classList.remove('active');
      document.getElementById('revision-prompt').value = '';
      revisionField = null;
    }

    async function submitRevisionRequest() {
      if (!revisionField || !currentCampaign) return;

      const prompt = document.getElementById('revision-prompt').value.trim();
      if (!prompt) {
        alert('Please enter a revision prompt');
        return;
      }

      const endpoint = revisionField === 'flashBrief' 
        ? `/api/campaigns/${currentCampaign.id}/flash-brief-revision`
        : `/api/campaigns/${currentCampaign.id}/storyboard-revision`;

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (response.ok) {
          const result = await response.json();
          alert(`Revision ${result.version} requested!\n\nPrompt: "${prompt}"\n\nStatus: Pending Klaus Agent processing`);
          closeRevisionModal();
          
          // Reload campaign to show new revision in history
          await viewCampaign(currentCampaign.id);
        }
      } catch (error) {
        console.error('Error submitting revision:', error);
        alert('Failed to request revision');
      }
    }

    async function loadRevisionHistory() {
      if (!currentCampaign) return;

      try {
        const response = await fetch(`/api/campaigns/${currentCampaign.id}/revisions`);
        const revisions = await response.json();

        // Display Flash Brief revisions
        const fbRevDiv = document.getElementById('flash-brief-revisions');
        if (revisions.flashBrief && revisions.flashBrief.length > 0) {
          fbRevDiv.innerHTML = `
            <strong>Revision History:</strong>
            ${revisions.flashBrief.map(r => `
              <div style="margin: 8px 0; padding: 8px; background: #f5f5f7; border-left: 3px solid #1da1f2;">
                <div style="font-weight: 600;">v${r.version} - ${r.status.toUpperCase()}</div>
                <div style="margin: 5px 0;">Prompt: "${r.prompt}"</div>
                <div style="font-size: 0.75rem; color: #999;">${new Date(r.requestedAt).toLocaleString()}</div>
              </div>
            `).join('')}
          `;
        }

        // Display Storyboard revisions
        const sbRevDiv = document.getElementById('storyboard-revisions');
        if (revisions.storyboard && revisions.storyboard.length > 0) {
          sbRevDiv.innerHTML = `
            <strong>Revision History:</strong>
            ${revisions.storyboard.map(r => `
              <div style="margin: 8px 0; padding: 8px; background: #f5f5f7; border-left: 3px solid #1da1f2;">
                <div style="font-weight: 600;">v${r.version} - ${r.status.toUpperCase()}</div>
                <div style="margin: 5px 0;">Prompt: "${r.prompt}"</div>
                <div style="font-size: 0.75rem; color: #999;">${new Date(r.requestedAt).toLocaleString()}</div>
              </div>
            `).join('')}
          `;
        }
      } catch (error) {
        console.error('Error loading revisions:', error);
      }
    }

    // Chat Interface Functions
    function addChatMessage(role, message) {
      const messagesDiv = document.getElementById('chat-messages');
      const messageEl = document.createElement('div');
      messageEl.style.cssText = role === 'user' 
        ? 'background: #7c3aed; color: white; padding: 10px 12px; border-radius: 6px; align-self: flex-end; max-width: 80%;'
        : 'background: #ffffff; border: 1px solid #e5e5e5; color: #333; padding: 10px 12px; border-radius: 6px; align-self: flex-start; max-width: 80%;';
      messageEl.textContent = message;
      messagesDiv.appendChild(messageEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message || !currentCampaign) return;

      // Add user message to chat
      addChatMessage('user', message);
      input.value = '';

      try {
        // Parse campaign ID to get company/country/product/number
        const parts = currentCampaign.id.split('-');
        if (parts.length < 4) {
          addChatMessage('ai', '‚ùå Could not parse campaign ID');
          return;
        }

        const [company, country, product, number] = [parts[0], parts[1], parts[2], parts[3]];

        // Send chat to server
        const response = await fetch('/api/chat-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            company,
            country,
            product,
            number,
            message,
            campaignData: currentCampaign
          })
        });

        const result = await response.json();

        if (result.success) {
          // Update campaign data with changes
          if (result.changes && result.changes.length > 0) {
            const changeText = result.changes.map(c => `${c.field}: ${c.oldValue} ‚Üí ${c.newValue}`).join(', ');
            addChatMessage('ai', `‚úÖ Updated: ${changeText}`);
            
            // Reload campaign to show updates
            await viewCampaign(currentCampaign.id);
          } else {
            addChatMessage('ai', result.response || '‚úÖ Understood!');
          }
        } else {
          addChatMessage('ai', `‚ùå ${result.error || 'Error processing message'}`);
        }
      } catch (error) {
        console.error('Chat error:', error);
        addChatMessage('ai', `‚ùå Error: ${error.message}`);
      }
    }

    async function regenerateMagicPatterns() {
      if (!currentCampaign) {
        alert('No campaign selected');
        return;
      }

      const button = event.target;
      button.disabled = true;
      button.textContent = '‚è≥ Regenerating...';

      try {
        const parts = currentCampaign.id.split('-');
        if (parts.length < 4) {
          throw new Error('Could not parse campaign ID');
        }

        const [company, country, product, number] = [parts[0], parts[1], parts[2], parts[3]];

        addChatMessage('ai', '‚ú® Regenerating Magic Patterns designs...');

        const response = await fetch('/api/regenerate-designs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            company,
            country,
            product,
            number,
            campaignData: currentCampaign
          })
        });

        const result = await response.json();

        if (result.success) {
          addChatMessage('ai', `‚úÖ ${result.message}\n\nNew mockups are ready! Check the storyboard for updated Magic Patterns links.`);
          
          // Reload storyboard to show new designs
          await viewCampaign(currentCampaign.id);
        } else {
          addChatMessage('ai', `‚ùå Error: ${result.error || 'Failed to regenerate'}`);
        }
      } catch (error) {
        console.error('Regeneration error:', error);
        addChatMessage('ai', `‚ùå Error: ${error.message}`);
      } finally {
        button.disabled = false;
        button.textContent = '‚ú® Regenerate Magic Patterns';
      }
    }

    // Allow Enter key in chat input
    document.addEventListener('DOMContentLoaded', () => {
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
        });
      }
    });

    // Load campaigns on page load
    loadCampaigns();
  </script>
</body>
</html>
